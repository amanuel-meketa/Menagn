<form nz-form [formGroup]="form" (ngSubmit)="submit()" class="modern-form">

  <!-- top card: template selector -->
  <nz-card nzBordered class="stage-card mb-4 header-card">
    <div class="header-top">
      <div class="header-left">
        <h2 class="title">Create Stage Flow <small class="muted"></small></h2>
        <p class="desc">Pick a template to apply, then configure stages below. Changes are local until you press “Submit All”.</p>
      </div>

      <div class="header-actions">
        <nz-form-item>
          <nz-form-control nzHasFeedback [nzValidateStatus]="form.get('templateId')!" [nzErrorTip]="'Please select a template'">
            <nz-select id="templateId" formControlName="templateId" nzPlaceHolder="Choose a template" nzShowSearch nzAllowClear>
              <nz-option *ngFor="let tpl of templates" [nzValue]="tpl.id" [nzLabel]="tpl.name"></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
  </nz-card>

  <!-- stepper -->
  <nz-steps [nzCurrent]="stageGroups.length - 1" nzSize="small" class="mb-4 compact-steps">
    <nz-step *ngFor="let _ of stageGroups; let idx = index" [nzTitle]="'Stage ' + (idx + 1)"></nz-step>
  </nz-steps>

  <!-- stages -->
  <nz-collapse [nzAccordion]="true" [nzBordered]="false" class="modern-collapse" [nzExpandIconPosition]="'end'">
    <nz-collapse-panel
      *ngFor="let group of stageGroups; let i = index; trackBy: trackByStageId"
      [formGroup]="group"
      [nzActive]="i === 0"
      class="modern-panel"
      [nzHeader]="hdrTpl"
    >
      <!-- header template (per-panel) -->
      <ng-template #hdrTpl>
        <div class="panel-header">
          <div class="left">
            <div class="stage-pill">#{{ i + 1 }}</div>
            <div class="title-and-sub">
              <div class="panel-title">{{ group.get('stageName')?.value || 'Unnamed stage' }}</div>
            </div>
          </div>
        </div>
      </ng-template>

      <nz-card nzBordered class="stage-card body-card">
        <div nz-row nzGutter="16" [formGroup]="group">

          <div nz-col nzXs="24" nzSm="12">
            <nz-form-item>
              <nz-form-label nzFor="stageName" nzRequired>Stage name</nz-form-label>
              <nz-form-control nzHasFeedback [nzValidateStatus]="group.get('stageName')!" [nzErrorTip]="'Required'">
                <input nz-input formControlName="stageName" placeholder="e.g. Finance approval" />
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col nzXs="24" nzSm="12">
            <nz-form-item>
              <nz-form-label nzFor="assignmentType" nzRequired>Assignment type</nz-form-label>
              <nz-form-control nzHasFeedback [nzValidateStatus]="group.get('assignmentType')!">
                <nz-select formControlName="assignmentType" nzPlaceHolder="Select type">
                  <nz-option nzValue="User" nzLabel="User"></nz-option>
                  <nz-option nzValue="Role" nzLabel="Role"></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col nzXs="24">
            <nz-form-item>
              <nz-form-label nzFor="description">Description</nz-form-label>
              <nz-form-control>
                <textarea nz-input formControlName="description" rows="2" placeholder="Optional short note about this stage"></textarea>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col nzXs="24" nzSm="12">
            <nz-form-item>
              <nz-form-label nzFor="assignmentKey" nzRequired>Assignment key</nz-form-label>
              <nz-form-control nzHasFeedback [nzValidateStatus]="group.get('assignmentKey')!">
                <input nz-input formControlName="assignmentKey" placeholder="e.g. finance-team or user-id" />
              </nz-form-control>
            </nz-form-item>
          </div>

        </div>

        <div class="panel-actions">
          <button nz-button nzType="text" nzDanger htmlType="button" (click)="onRemove($event, i)">
            <span nz-icon nzType="delete"></span> Remove
          </button>
          <div class="spacer"></div>
          <div class="small-note">Tip: use <strong>Role</strong> for groups and <strong>User</strong> for individual approvers.</div>
        </div>
      </nz-card>
    </nz-collapse-panel>
  </nz-collapse>

  <!-- sticky footer actions -->
  <nz-affix [nzOffsetBottom]="16">
    <div class="form-actions footer-card">
      <div class="left">
        <button nz-button nzType="dashed" htmlType="button" (click)="onAdd($event)">
          <span nz-icon nzType="plus"></span> Add Stage
        </button>
      </div>

      <div class="right">
        <button nz-button nzType="primary" htmlType="submit" [disabled]="form.invalid">
          <span nz-icon nzType="check-circle"></span> Submit All
        </button>
      </div>
    </div>
  </nz-affix>

</form>
