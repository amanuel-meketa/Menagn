<form nz-form [formGroup]="form" (ngSubmit)="submit()" class="modern-form">

    <!-- ðŸ”¹ Template Selection -->
    <nz-card nzBordered class="stage-card mb-4">
      <div nz-row nzGutter="16">
        <div nz-col nzSpan="24">
          <nz-form-item>
            <nz-form-label nzFor="templateId" nzRequired>
              <span nz-icon nzType="copy"></span> Select Template
            </nz-form-label>
            <nz-form-control
              nzHasFeedback
              [nzValidateStatus]="form.get('templateId')!"
              [nzErrorTip]="'Please select a template'"
            >
              <nz-select
                id="templateId"
                formControlName="templateId"
                nzPlaceHolder="Choose a template"
                nzShowSearch
              >
                <nz-option 
                  *ngFor="let tpl of templates" 
                  [nzValue]="tpl.id" 
                  [nzLabel]="tpl.name">
                </nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>
    </nz-card>
  
    <!-- ðŸ”¹ Steps Indicator -->
    <nz-steps [nzCurrent]="stageGroups.length - 1" nzSize="small" class="mb-4">
      <nz-step *ngFor="let _ of stageGroups; let idx = index" [nzTitle]="'Stage ' + (idx + 1)"></nz-step>
    </nz-steps>
  
    <!-- ðŸ”¹ Stages Form -->
    <nz-collapse [nzAccordion]="true" [nzBordered]="false" class="modern-collapse" [nzExpandIconPosition]="'end'">
      <nz-collapse-panel 
        *ngFor="let group of stageGroups; let i = index"
        [nzHeader]="'Stage ' + (i + 1) + ': ' + (group.get('stageName')?.value || 'Unnamed')"
        [nzActive]="i === 0"
        class="modern-panel"
      >
        <nz-card nzBordered class="stage-card">
          <div nz-row nzGutter="16" [formGroup]="group">
  
            <!-- Stage Name -->
            <div nz-col nzXs="24" nzSm="12">
              <nz-form-item>
                <nz-form-label nzFor="stageName" nzRequired>
                  <span nz-icon nzType="edit"></span> Stage Name
                </nz-form-label>
                <nz-form-control 
                  nzHasFeedback 
                  [nzValidateStatus]="group.get('stageName')!" 
                  [nzErrorTip]="'Required'"
                >
                  <input nz-input id="stageName" formControlName="stageName" placeholder="Enter stage name"/>
                </nz-form-control>
              </nz-form-item>
            </div>
  
            <!-- Description -->
            <div nz-col nzSpan="24">
              <nz-form-item>
                <nz-form-label nzFor="description">Description</nz-form-label>
                <nz-form-control>
                  <textarea 
                    nz-input 
                    id="description" 
                    formControlName="description" 
                    rows="2" 
                    placeholder="Optional description"
                  ></textarea>
                </nz-form-control>
              </nz-form-item>
            </div>
  
            <!-- Assignment Type -->
            <div nz-col nzXs="24" nzSm="12">
              <nz-form-item>
                <nz-form-label nzFor="assignmentType" nzRequired>
                  <span nz-icon nzType="user"></span> Assignment Type
                </nz-form-label>
                <nz-form-control 
                  nzHasFeedback 
                  [nzValidateStatus]="group.get('assignmentType')!" 
                  [nzErrorTip]="'Required'"
                >
                  <nz-select id="assignmentType" formControlName="assignmentType" nzPlaceHolder="Select type" nzShowSearch>
                    <nz-option nzValue="User" nzLabel="User"></nz-option>
                    <nz-option nzValue="Role" nzLabel="Role"></nz-option>
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
            </div>
  
            <!-- Assignment Key -->
            <div nz-col nzXs="24" nzSm="12">
              <nz-form-item>
                <nz-form-label nzFor="assignmentKey" nzRequired>
                  <span nz-icon nzType="key"></span> Assignment Key
                </nz-form-label>
                <nz-form-control 
                  nzHasFeedback 
                  [nzValidateStatus]="group.get('assignmentKey')!" 
                  [nzErrorTip]="'Required'"
                >
                  <input nz-input id="assignmentKey" formControlName="assignmentKey" placeholder="e.g. finance-team"/>
                </nz-form-control>
              </nz-form-item>
            </div>
  
          </div>
  
          <!-- Remove Button -->
          <div class="btn-row mt-2" *ngIf="stages.length > 1">
            <button nz-button nzType="text" nzDanger (click)="removeStage(i)">
              <span nz-icon nzType="delete"></span> Remove Stage
            </button>
          </div>
        </nz-card>
      </nz-collapse-panel>
    </nz-collapse>
  
    <!-- ðŸ”¹ Sticky Actions -->
    <nz-affix [nzOffsetBottom]="16">
      <div class="form-actions">
        <button nz-button nzType="dashed" (click)="addStage()">
          <span nz-icon nzType="plus"></span> Add Stage
        </button>
        <button nz-button nzType="primary" htmlType="submit" [disabled]="form.invalid">
          <span nz-icon nzType="check-circle"></span> Submit All
        </button>
      </div>
    </nz-affix>
  
  </form>
  